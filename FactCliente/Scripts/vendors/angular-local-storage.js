var isDefined=angular.isDefined,isUndefined=angular.isUndefined,isNumber=angular.isNumber,isObject=angular.isObject,isArray=angular.isArray,isString=angular.isString,extend=angular.extend,toJson=angular.toJson;angular.module("LocalStorageModule",[]).provider("localStorageService",function(){this.prefix="ls";this.storageType="localStorage";this.cookie={expiry:30,path:"/",secure:!1};this.defaultToCookie=!0;this.notify={setItem:!0,removeItem:!1};this.setPrefix=function(c){this.prefix=c;return this};this.setStorageType=function(c){this.storageType=c;return this};this.setDefaultToCookie=function(c){this.defaultToCookie=!!c;return this};this.setStorageCookie=function(c,e,l){this.cookie.expiry=c;this.cookie.path=e;this.cookie.secure=l;return this};this.setStorageCookieDomain=function(c){this.cookie.domain=c;return this};this.setNotify=function(c,e){this.notify={setItem:c,removeItem:e};return this};this.$get=["$rootScope","$window","$document","$parse","$timeout",function(c,e,l,F,G){function v(a){a||(a=e.event);if(t.setItem&&isString(a.key)&&0===a.key.indexOf(g)){var b=A(a.key);G(function(){c.$broadcast("LocalStorageModule.notification.changed",{key:b,newvalue:a.newValue,storageType:f.storageType})})}}var f=this,g=f.prefix,r=f.cookie,t=f.notify,p=f.storageType,n;l?l[0]&&(l=l[0]):l=document;"."!==g.substr(-1)&&(g=g?g+".":"");var A=function(a){return a.replace(new RegExp("^"+g,"g"),"")},B=function(){try{var a=p in e&&null!==e[p],b=g+("__"+Math.round(1E7*Math.random()));a&&(n=e[p],n.setItem(b,""),n.removeItem(b));return a}catch(d){return f.defaultToCookie&&(p="cookie"),c.$broadcast("LocalStorageModule.notification.error",d.message),!1}},k=B(),y=function(a,b,d){q(d);b=isUndefined(b)?null:toJson(b);if(!k&&f.defaultToCookie||"cookie"===f.storageType)return k||c.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),t.setItem&&c.$broadcast("LocalStorageModule.notification.setitem",{key:a,newvalue:b,storageType:"cookie"}),u(a,b);try{n&&n.setItem(g+a,b),t.setItem&&c.$broadcast("LocalStorageModule.notification.setitem",{key:a,newvalue:b,storageType:f.storageType})}catch(h){return c.$broadcast("LocalStorageModule.notification.error",h.message),u(a,b)}return!0},D=function(a,b){q(b);if(!k&&f.defaultToCookie||"cookie"===f.storageType)return k||c.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),C(a);var d=n?n.getItem(g+a):null;if(!d||"null"===d)return null;try{return JSON.parse(d)}catch(h){return d}},E=function(){var a=0;1<=arguments.length&&("localStorage"===arguments[arguments.length-1]||"sessionStorage"===arguments[arguments.length-1])&&(a=1,q(arguments[arguments.length-1]));var b;for(b=0;b<arguments.length-a;b++){var d=arguments[b];if(!k&&f.defaultToCookie||"cookie"===f.storageType)k||c.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),t.removeItem&&c.$broadcast("LocalStorageModule.notification.removeitem",{key:d,storageType:"cookie"}),w(d);else try{n.removeItem(g+d),t.removeItem&&c.$broadcast("LocalStorageModule.notification.removeitem",{key:d,storageType:f.storageType})}catch(h){c.$broadcast("LocalStorageModule.notification.error",h.message),w(d)}}};try{var x=e.navigator.cookieEnabled||"cookie"in
l&&(0<l.cookie.length||-1<(l.cookie="test").indexOf.call(l.cookie,"test"))}catch(a){c.$broadcast("LocalStorageModule.notification.error",a.message),x=!1}var u=function(a,b,d,h){if(isUndefined(b))return!1;if(isArray(b)||isObject(b))b=toJson(b);if(!x)return c.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var f="",m=new Date,e="";null===b?(m.setTime(m.getTime()+-864E5),f="; expires="+m.toGMTString(),b=""):isNumber(d)&&0!==d?(m.setTime(m.getTime()+864E5*d),f="; expires="+m.toGMTString()):0!==r.expiry&&(m.setTime(m.getTime()+864E5*r.expiry),f="; expires="+m.toGMTString());if(a){var k="; path="+r.path;r.domain&&(e="; domain="+r.domain);"boolean"===typeof h?!0===h&&(e+="; secure"):!0===r.secure&&(e+="; secure");l.cookie=g+a+"="+encodeURIComponent(b)+f+k+e}}catch(I){return c.$broadcast("LocalStorageModule.notification.error",I.message),!1}return!0},C=function(a){if(!x)return c.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var b=l.cookie&&l.cookie.split(";")||[],d=0;d<b.length;d++){for(var h=b[d];" "===h.charAt(0);)h=h.substring(1,h.length);if(0===h.indexOf(g+a+"=")){a=decodeURIComponent(h.substring(g.length+a.length+1,h.length));try{var f=JSON.parse(a);return"number"===typeof f?a:f}catch(m){return a}}}return null},w=function(a){u(a,null)},z=function(){for(var a,b=g.length,d=l.cookie.split(";"),c=0;c<d.length;c++){for(a=d[c];" "===a.charAt(0);)a=a.substring(1,a.length);a=a.substring(b,a.indexOf("="));w(a)}},q=function(a){a&&p!==a&&(p=a,k=B());return k};k&&(e.addEventListener?(e.addEventListener("storage",v,!1),c.$on("$destroy",function(){e.removeEventListener("storage",v)})):e.attachEvent&&(e.attachEvent("onstorage",v),c.$on("$destroy",function(){e.detachEvent("onstorage",v)})));return{isSupported:k,getStorageType:function(){return p},setStorageType:q,set:y,add:y,get:D,keys:function(a){q(a);if(!k)return c.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),[];a=g.length;var b=[],d;for(d in n)if(d.substr(0,a)===g)try{b.push(d.substr(a))}catch(h){return c.$broadcast("LocalStorageModule.notification.error",h.Description),[]}return b},remove:E,clearAll:function(a,b){q(b);var d=g?new RegExp("^"+g):RegExp(),h=a?new RegExp(a):RegExp();if(!k&&f.defaultToCookie||"cookie"===f.storageType)return k||c.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),z();if(!k&&!f.defaultToCookie)return!1;var e=g.length,m;for(m in n)if(d.test(m)&&h.test(m.substr(e)))try{E(m.substr(e))}catch(H){return c.$broadcast("LocalStorageModule.notification.error",H.message),z()}return!0},bind:function(a,b,d,c,f){c=c||b;var e=D(c,f);null===e&&isDefined(d)?e=d:isObject(e)&&isObject(d)&&(e=extend(e,d));F(b).assign(a,e);return a.$watch(b,function(a){y(c,a,f)},isObject(a[b]))},deriveKey:function(a){return g+a},underiveKey:A,length:function(a){q(a);a=0;for(var b=e[p],c=0;c<b.length;c++)0===b.key(c).indexOf(g)&&a++;return a},defaultToCookie:this.defaultToCookie,cookie:{isSupported:x,set:u,add:u,get:C,remove:w,clearAll:z}}}]});